# 2025-04-22-后端单仓微服务改造-阶段二

## 时间：2025-04-22 16:00

## 完成内容

完成了后端单仓微服务架构改造的第二阶段设计：核心服务迁移（4周）。本文档详细说明了第二阶段的改造步骤和具体实施方案。

## 实施步骤详解：核心服务迁移（4周）

### 第三周：认证服务迁移

#### 1. 创建认证服务

1. **生成认证服务应用**
   ```bash
   nx g @nx/nest:app auth-service
   ```

2. **迁移认证模块**
   - 从原系统移植用户模块
   - 从原系统移植角色模块
   - 从原系统移植认证功能

3. **实现JWT服务**
   - 在`libs/auth`中实现JWT服务
   - 配置认证服务生成令牌
   - 配置网关验证令牌

#### 2. 迁移用户管理功能

1. **迁移用户模型**
   - 确保Prisma模型正确配置
   - 实现用户数据访问层

2. **实现用户CRUD功能**
   - 迁移用户管理API
   - 调整依赖关系

3. **迁移角色管理功能**
   - 迁移角色相关API
   - 配置权限检查

#### 3. 网关集成认证服务

1. **配置认证路由**
   - 在网关中配置认证路由
   - 实现登录/注销功能转发

2. **实现身份验证中间件**
   - 在网关中验证JWT令牌
   - 配置权限检查

3. **测试认证流程**
   - 验证登录/注销功能
   - 测试授权检查

### 第四周：系统服务迁移

#### 1. 创建系统服务

1. **生成系统服务应用**
   ```bash
   nx g @nx/nest:app system-service
   ```

2. **迁移配置模块**
   - 从原系统移植配置管理模块
   - 调整共享配置的访问机制

3. **实现配置CRUD功能**
   - 迁移配置管理API
   - 添加配置缓存机制

#### 2. 迁移字典管理功能

1. **迁移字典模型**
   - 确保Prisma模型正确配置
   - 实现字典数据访问层

2. **实现字典CRUD功能**
   - 迁移字典管理API
   - 配置字典缓存

3. **迁移通知管理功能**
   - 迁移通知相关API
   - 配置通知事件机制

#### 3. 集成消息队列

1. **安装消息队列依赖**
   ```bash
   pnpm add amqplib @types/amqplib
   ```

2. **实现消息生产者服务**
   - 在系统服务中实现消息生产
   - 配置消息序列化

3. **实现消息消费者服务**
   - 在相关服务中实现消息消费
   - 测试消息传递机制

### 第五周：配置服务间通信

#### 1. 设计服务通信接口

1. **定义微服务消息契约**
   - 在`libs/interfaces`中定义消息格式
   - 定义服务间的命令和事件

2. **实现请求-响应模式**
   - 配置TCP传输层
   - 实现服务间的同步调用

3. **实现事件驱动模式**
   - 配置Redis或RabbitMQ事件总线
   - 实现事件发布和订阅

#### 2. 实现服务发现

1. **配置服务注册**
   - 实现服务启动时的注册逻辑
   - 配置健康检查

2. **实现服务发现**
   - 实现服务查询机制
   - 配置负载均衡策略

3. **配置服务网络**
   - 更新docker-compose配置
   - 配置服务间的网络连接

#### 3. 测试服务通信

1. **编写集成测试**
   - 测试服务间的同步调用
   - 测试事件发布和订阅

2. **性能测试**
   - 测试服务间通信的延迟
   - 测试系统吞吐量

3. **调整通信策略**
   - 根据测试结果优化通信方式
   - 调整序列化和压缩策略

### 第六周：日志和监控服务迁移

#### 1. 创建监控服务

1. **生成监控服务应用**
   ```bash
   nx g @nx/nest:app monitoring-service
   ```

2. **迁移API监控模块**
   - 从原系统移植API监控功能
   - 调整数据收集机制

3. **迁移系统资源监控**
   - 迁移系统资源监控功能
   - 配置资源使用预警

#### 2. 实现分布式日志

1. **配置日志收集**
   - 实现统一的日志格式
   - 配置日志聚合服务

2. **实现日志查询**
   - 迁移日志查询API
   - 实现日志过滤和检索

3. **实现日志分析**
   - 迁移日志统计功能
   - 配置日志预警机制

#### 3. 实现健康检查

1. **配置服务健康检查**
   - 实现服务健康端点
   - 配置健康检查逻辑

2. **实现系统仪表盘**
   - 迁移系统监控仪表盘
   - 配置实时数据更新

3. **配置告警机制**
   - 实现服务不可用告警
   - 配置性能瓶颈告警

## 技术实现要点

1. 使用JWT实现集中式身份验证
2. 基于消息队列实现服务间异步通信
3. 实现服务注册与发现机制
4. 配置分布式日志收集和分析
5. 建立完整的健康检查和告警系统

## 预期成果

1. 独立运行的认证服务和系统服务
2. 完整的服务间通信机制
3. 分布式日志和监控系统
4. 微服务健康检查机制

## 风险与应对措施

1. **认证安全性**：进行安全审核，确保令牌生成和验证逻辑无漏洞
2. **服务通信可靠性**：实现重试机制和熔断器
3. **监控盲点**：确保全面覆盖关键指标监控
4. **性能瓶颈**：关注服务间通信的性能，优化高频调用

## 下一步行动

1. 开始认证服务的设计和实现
2. 准备消息队列环境
3. 制定服务通信协议
4. 设计监控指标体系