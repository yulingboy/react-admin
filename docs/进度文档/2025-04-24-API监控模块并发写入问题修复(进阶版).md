# API监控模块并发写入问题修复

**日期时间**: 2025年4月24日 20:30

## 问题描述

在高并发场景下，API监控队列处理器出现了唯一约束冲突错误：

```
Unique constraint failed on the constraint: `api_monitors_path_method_date_key`
```

这是因为多个相同路径、方法和日期的API请求同时尝试执行upsert操作，导致违反了数据库唯一约束。

## 解决方案

1. **替换upsert操作**：
   - 原来使用的upsert操作在高并发下容易产生冲突
   - 修改为使用事务内的findUnique + update/create操作组合

2. **增加重试机制**：
   - 添加最大重试次数(3次)
   - 为重试添加随机延迟(100-300ms)
   - 专门识别并处理唯一约束冲突错误(P2002)

3. **改进错误处理**：
   - 改进错误日志，记录更多上下文信息
   - 在达到最大重试次数后不再抛出异常，避免队列任务反复失败

## 技术细节

- 使用Prisma事务(`$transaction`)代替单一的upsert操作
- 设置事务隔离级别为`Serializable`，确保高并发下的数据一致性
- 使用指数退避策略进行重试，减少冲突概率
- 使用`PrismaClientKnownRequestError`和错误代码识别唯一约束错误

## 收益

- 解决了高并发场景下API监控数据写入的可靠性问题
- 提高了系统在处理大量API请求时的稳定性
- 改进了错误日志，便于排查问题
- 确保了API监控数据的完整性和准确性