# 后端模块重组方案

## 目标
将现有的后端模块重新组织为四个主要类别：
- 认证模块 (auth-module)
- 系统监控模块 (monitoring-module)
- 系统管理模块 (system-module)
- 工具类模块 (tools-module)

## 模块分类

### 1. 认证模块（auth-module）
- auth - 认证相关功能
- users - 用户管理
- roles - 角色管理

### 2. 系统监控模块（monitoring-module）
- api-monitor - API监控
- log-stats - 日志统计
- system-health - 系统健康
- system-resource - 系统资源监控

### 3. 系统管理模块（system-module）
- configs - 系统配置
- dictionaries - 字典管理
- notifications - 通知管理

### 4. 工具类模块（tools-module）
- api-tester - API测试工具
- code-generator - 代码生成器
- db-manager - 数据库管理
- sql-executor - SQL执行工具

## 实施步骤

1. 在 `src/modules` 下创建四个新的目录：
   ```bash
   mkdir src/modules/auth-module
   mkdir src/modules/monitoring-module
   mkdir src/modules/system-module
   mkdir src/modules/tools-module
   ```

2. 将现有模块移动到相应的新目录下：
   ```bash
   # 认证模块
   mv src/modules/auth src/modules/auth-module/
   mv src/modules/users src/modules/auth-module/
   mv src/modules/roles src/modules/auth-module/

   # 系统监控模块
   mv src/modules/api-monitor src/modules/monitoring-module/
   mv src/modules/log-stats src/modules/monitoring-module/
   mv src/modules/system-health src/modules/monitoring-module/
   mv src/modules/system-resource src/modules/monitoring-module/

   # 系统管理模块
   mv src/modules/configs src/modules/system-module/
   mv src/modules/dictionaries src/modules/system-module/
   mv src/modules/notifications src/modules/system-module/

   # 工具类模块
   mv src/modules/api-tester src/modules/tools-module/
   mv src/modules/code-generator src/modules/tools-module/
   mv src/modules/db-manager src/modules/tools-module/
   mv src/modules/sql-executor src/modules/tools-module/
   ```

3. 为每个主模块创建一个聚合模块文件（index.module.ts），以便于导入：
   - `src/modules/auth-module/auth-module.module.ts`
   - `src/modules/monitoring-module/monitoring-module.module.ts`
   - `src/modules/system-module/system-module.module.ts`
   - `src/modules/tools-module/tools-module.module.ts`

4. 更新 `app.module.ts` 中的导入路径，使用新的模块结构。

## 聚合模块示例

### auth-module.module.ts
```typescript
import { Module } from '@nestjs/common';
import { AuthModule } from './auth/auth.module';
import { UsersModule } from './users/users.module';
import { RolesModule } from './roles/roles.module';

@Module({
  imports: [AuthModule, UsersModule, RolesModule],
  exports: [AuthModule, UsersModule, RolesModule],
})
export class AuthModuleGroup {}
```

### monitoring-module.module.ts
```typescript
import { Module } from '@nestjs/common';
import { ApiMonitorModule } from './api-monitor/api-monitor.module';
import { LogStatsModule } from './log-stats/log-stats.module';
import { SystemHealthModule } from './system-health/system-health.module';
import { SystemResourceModule } from './system-resource/system-resource.module';

@Module({
  imports: [ApiMonitorModule, LogStatsModule, SystemHealthModule, SystemResourceModule],
  exports: [ApiMonitorModule, LogStatsModule, SystemHealthModule, SystemResourceModule],
})
export class MonitoringModuleGroup {}
```

### system-module.module.ts
```typescript
import { Module } from '@nestjs/common';
import { ConfigsModule } from './configs/configs.module';
import { DictionariesModule } from './dictionaries/dictionaries.module';
import { NotificationsModule } from './notifications/notifications.module';

@Module({
  imports: [ConfigsModule, DictionariesModule, NotificationsModule],
  exports: [ConfigsModule, DictionariesModule, NotificationsModule],
})
export class SystemModuleGroup {}
```

### tools-module.module.ts
```typescript
import { Module } from '@nestjs/common';
import { ApiTesterModule } from './api-tester/api-tester.module';
import { CodeGeneratorModule } from './code-generator/code-generator.module';
import { DbManagerModule } from './db-manager/db-manager.module';
import { SqlExecutorModule } from './sql-executor/sql-executor.module';

@Module({
  imports: [ApiTesterModule, CodeGeneratorModule, DbManagerModule, SqlExecutorModule],
  exports: [ApiTesterModule, CodeGeneratorModule, DbManagerModule, SqlExecutorModule],
})
export class ToolsModuleGroup {}
```

## 更新 app.module.ts

```typescript
import { Module, NestModule, MiddlewareConsumer } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { PrismaModule } from './shared/prisma/prisma.module';
import { LoggerModule } from './shared/logger/logger.module';
import { APP_FILTER, APP_INTERCEPTOR } from '@nestjs/core';
import { AllExceptionsFilter } from './common/filters/all-exceptions.filter';
import { NotFoundExceptionFilter } from './common/filters/not-found.filter';
import { ConfigModule } from '@nestjs/config';
import { HttpLoggerMiddleware } from './common/middleware/http-logger.middleware';
import { ApiMonitorInterceptor } from './modules/monitoring-module/api-monitor/api-monitor.interceptor';
import { ScheduleModule } from '@nestjs/schedule';
import databaseConfig from './config/database.config';
import redisConfig from './config/redis.config';

// 导入重组后的模块组
import { AuthModuleGroup } from './modules/auth-module/auth-module.module';
import { MonitoringModuleGroup } from './modules/monitoring-module/monitoring-module.module';
import { SystemModuleGroup } from './modules/system-module/system-module.module';
import { ToolsModuleGroup } from './modules/tools-module/tools-module.module';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      load: [databaseConfig, redisConfig],
    }),
    ScheduleModule.forRoot(),
    PrismaModule,
    LoggerModule,
    // 导入重组后的模块组
    AuthModuleGroup,
    MonitoringModuleGroup,
    SystemModuleGroup,
    ToolsModuleGroup
  ],
  controllers: [AppController],
  providers: [
    AppService,
    {
      provide: APP_FILTER,
      useClass: AllExceptionsFilter,
    },
    {
      provide: APP_FILTER,
      useClass: NotFoundExceptionFilter,
    },
    {
      provide: APP_INTERCEPTOR,
      useClass: ApiMonitorInterceptor,
    },
  ],
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer.apply(HttpLoggerMiddleware).forRoutes('*');
  }
}
```

## 注意事项

1. 移动模块后，可能需要更新模块内部的导入路径，特别是模块之间有依赖关系的情况。
2. 对于全局使用的拦截器、过滤器等，需要确保路径更新。
3. 根据需要，可能还需要更新前端API调用的路径。
4. 在实施过程中建议先备份代码，或在Git中创建一个新分支来进行这些更改。